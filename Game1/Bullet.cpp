#include "stdafx.h"

Bullet* Bullet::Create(string name)
{
	Bullet* temp = new Bullet();
	temp->type = ObType::Actor;
	temp->isFire = false;
	temp->isCollsion = false;
	temp->extinctionTime = 0.0f;
	
	/*switch (temp->bulletParticle->poptype)
	{
	case PopType::LEMURIANBULLET :
		temp->bulletParticle->LoadFile("Particle_Fire.xml");
		break;
	case PopType::PLAYERBULLET:
		temp->bulletParticle->LoadFile("Particle_Fire.xml");
		break;
	case PopType::GOLEMLAZER:
		temp->bulletParticle->LoadFile("Particle_Fire.xml");
		break;
	case PopType::BOSSBULLET1:
		temp->bulletParticle->LoadFile("Particle_Fire.xml");
		break;
	case PopType::BOSSBULLET2:
		temp->bulletParticle->LoadFile("Particle_Fire.xml");
		break;
	default:
		break;
	
	}*/
	
	return temp;
}

Bullet::Bullet()
{
}

Bullet::~Bullet()
{
}

void Bullet::SetPos(Vector3 pos)
{
	SetWorldPos(pos);
}

void Bullet::CollisionWithMap()//맵과 총알 충돌
{
	
	Vector3 hit;
	BulletRay.position = GetWorldPos();
	BulletRay.direction =GetForward();
	if (Utility::RayIntersectMap(BulletRay, GM->map, hit))//맵과 몬스터 레이 이용해 몬스터 y값 잡기
	{
		if ((hit - GetWorldPos()).Length() < 1.0f)
		{
			bulletParticle->SetWorldPos(hit);
			GM->particlePool.push_back(bulletParticle);
			isCollsion = true;
		}
	}
	

}

void Bullet::Update()
{
	if (!isFire) return;
	Actor::Update();

	Vector3 velocity = fireDir * power;
	MoveWorldPos(velocity * DELTA);

	CollisionWithMap();


	if (TIMER->GetTick(extinctionTime, 10.0f))
	{
		this->isCollsion = true;
	}

	//if (this->Intersect(GM->player->Find("RootNode"))) //총알과 플레이어 충돌
	//{
	//	//소멸 시키고
	//	this->isCollsion = true;
	//	GM->player->hp -= 7;//플레이어 피깎기
	//}

	for (auto& monster : GM->monsterPool)//총알과 몬스터와의 충돌
	{
		if (this->Intersect(GM->player->Find("RootNode"))) //총알과 플레이어 충돌
		{
			bulletParticle->SetWorldPos(GM->player->Find("RootNode")->GetWorldPos());
			GM->particlePool.push_back(bulletParticle);

			//소멸 시키고
			this->isCollsion = true;
			GM->player->hp -= monster->attack;//플레이어 피깎기
			GM->player->DecreaseHP();
		}

		//if (this->Intersect(monster->Find("RootNode")))
		//{
		//	this->isCollsion = true;
		//	monster->Hp -= 20;//플레이어 피깎기
		//}
	}

	for (auto& feature : GM->featurePool)
	{
		if (this->Intersect(feature->feature->Find("RootNode"))) //총알과 지물 충돌
		{
			bulletParticle->SetWorldPos(feature->feature->Find("RootNode")->GetWorldPos());
			GM->particlePool.push_back(bulletParticle);
		
			//소멸 시키고
			this->isCollsion = true;

		}
	}
	
	
	
}

void Bullet::Render(shared_ptr<Shader> pShader)
{
	if (!isFire) return;


	Actor::Render();
	
}

void Bullet::Fire(Vector3 dir, float power, Vector3 rotation)
{
	isFire = true;
	this->power = power;
	this->fireDir = dir;
	this->rotation.x = HALFPI;
	this->rotation.y = rotation.y;
}